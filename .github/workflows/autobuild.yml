name: AutoBuild

on:
  push:
    branches: [dev]         # dev ÂàÜÊîØ push Êó∂Ëß¶Âèë
  schedule:
    - cron: '0 0 * * *'    # ÊØèÂ§© 00:00 UTC ÊûÑÂª∫‰∏ÄÊ¨° Nightly
  workflow_dispatch:        # ÊâãÂä®Ëß¶Âèë

permissions:
  contents: write  # ÂÖÅËÆ∏ÂàõÂª∫/Êõ¥Êñ∞ release„ÄÅ‰∏ä‰º†Êñá‰ª∂

concurrency:
  group: autobuild-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # Á¨¨‰∏ÄÊ≠•ÔºöÂà†Èô§Êóß releaseÔºåÂàõÂª∫Êñ∞ÁöÑ release
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Delete old autobuild release (if exists)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Â∞ùËØïÂà†Èô§ÊóßÁöÑ release
          gh release delete autobuild --yes --repo "${{ github.repository }}" 2>/dev/null || echo "No existing release to delete"
          # Â∞ùËØïÂà†Èô§ÊóßÁöÑ tag
          gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/autobuild" 2>/dev/null || echo "No existing tag to delete"
          echo "‚úÖ Cleaned up old release and tag"

      - name: Create new autobuild release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: autobuild
          name: 'Antigravity Agent Nightly (${{ github.event.head_commit.timestamp }})'
          body: |
            Nightly build from dev branch.

            üïê Last updated: ${{ github.event.head_commit.timestamp }}
            üì¶ Commit: ${{ github.sha }}

            ---
            ## üì• ‰∏ãËΩΩÂÆâË£Ö

            ‚ö†Ô∏è **Ê≥®ÊÑè**ÔºöËøôÊòØËá™Âä®ÊûÑÂª∫ÁöÑÊµãËØïÁâàÊú¨ÔºåÂèØËÉΩ‰∏çÁ®≥ÂÆö„ÄÇÂª∫ËÆÆÊôÆÈÄöÁî®Êà∑‰ΩøÁî® [Ê≠£ÂºèÂèëÂ∏ÉÁâàÊú¨](https://github.com/MonchiLin/antigravity-agent/releases/latest)„ÄÇ

            ### VS Code Êèí‰ª∂
            - [VSIXÂÆâË£ÖÂåÖ (Nightly)](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/antigravity-agent-nightly.vsix)
            
            ### Windows
            - [ÂÆâË£ÖÁâà(Êé®Ëçê)](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity.Agent_x64-setup.exe) | [‰æøÊê∫Áâà](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity-Agent-x86_64-Portable.zip)

            ### macOS
            - [Apple Silicon](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity.Agent_aarch64.dmg) | [IntelËäØÁâá](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/Antigravity.Agent_x86_64.dmg)
            
            ### Linux
            **AppImage(ÈÄöÁî® Êé®Ëçê)**
            - [Antigravity_Agent.AppImage](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/antigravity-agent_amd64.AppImage)
            - [Antigravity_Agent.deb](${{ github.server_url }}/${{ github.repository }}/releases/download/autobuild/antigravity-agent_amd64.deb)
            ---

            üêõ Â¶ÇÊûúÂèëÁé∞ÈóÆÈ¢òÊàñËÄÖÈúÄÊ±ÇËØ∑Ê±ÇÔºåËØ∑[Êèê‰∫§ Issue](https://github.com/MonchiLin/antigravity-agent/issues/new)
          prerelease: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Á¨¨‰∫åÊ≠•ÔºöÂπ∂Ë°åÊûÑÂª∫
  build:
    needs: prepare-release
    uses: ./.github/workflows/tauri-build.yml
    with:
      tag: autobuild
      ref: dev
      cache_key_suffix: autobuild
    secrets: inherit

  # Á¨¨‰∏âÊ≠•ÔºöÊûÑÂª∫ VS Code Êèí‰ª∂
  build-extension:
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json

      - name: Install Root Dependencies
        run: npm ci --ignore-scripts --no-audit --prefer-offline

      - name: Get Version
        id: version
        working-directory: ./vscode-extension
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìç Using extension version $VERSION"

      - name: Bump to Nightly Version
        working-directory: ./vscode-extension
        run: |
          # Create version like 1.5.3-nightly.202312271230
          TIMESTAMP=$(date +%Y%m%d%H%M)
          # Use npm version to update package.json without git tag
          npm version prerelease --preid="nightly.$TIMESTAMP" --no-git-tag-version
          
          # Read new version back
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "Current Nightly Version: $NEW_VERSION"

      - name: Install dependencies
        working-directory: ./vscode-extension
        run: npm ci

      - name: Build and Package Extension (Nightly)
        working-directory: ./vscode-extension
        # Use dynamic filename based on package.json version
        run: npx @vscode/vsce package --out ./antigravity-agent-nightly.vsix

      - name: Upload Extension to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload autobuild vscode-extension/antigravity-agent-nightly.vsix --clobber --repo "${{ github.repository }}"

      - name: Publish to Open VSX
        # Always run, version collision handled by timestamp
        working-directory: ./vscode-extension
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        run: |
          if [ -z "$OVSX_PAT" ]; then
            echo "‚ö†Ô∏è OVSX_PAT secret not found, skipping Open VSX publish"
            exit 0
          fi
          
          # Publish the file we just built
          npx ovsx publish ./antigravity-agent-nightly.vsix --pat "$OVSX_PAT"


