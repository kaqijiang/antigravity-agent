name: Release Build v2

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # Step 1: ÂÖàÂàõÂª∫ Release
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
          else
            VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
            TAG="v$VERSION"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: 'Antigravity Agent ${{ steps.version.outputs.tag }}'
          body: |
            ### VS Code Êèí‰ª∂
            - [VSIXÂÆâË£ÖÂåÖ](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/antigravity-agent-${{ steps.version.outputs.version }}.vsix)

            ### Windows
            - [ÂÆâË£ÖÁâà(Êé®Ëçê)](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity.Agent_${{ steps.version.outputs.version }}_x64-setup.exe) | [‰æøÊê∫Áâà](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity-Agent-x86_64-Portable.zip)

            ### macOS
            - [Apple Silicon](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity.Agent_${{ steps.version.outputs.version }}_aarch64.dmg) | [IntelËäØÁâá](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity.Agent_${{ steps.version.outputs.version }}_x86_64.dmg)

            ### Linux
            **AppImage(ÈÄöÁî® Êé®Ëçê)**
            - [Antigravity_Agent.AppImage](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/antigravity-agent_${{ steps.version.outputs.version }}_amd64.AppImage)
            - [Antigravity_Agent.deb](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/antigravity-agent_${{ steps.version.outputs.version }}_amd64.deb)
            ---
            ---

            ## üìã Êõ¥Êñ∞Êó•Âøó

            ${{ github.event.release.body || format('ËØ∑Êü•Áúã [Êèê‰∫§ÂéÜÂè≤](https://github.com/{0}/commits/{1}) Ëé∑ÂèñËØ¶ÁªÜÁöÑÊõ¥Êñ∞ÂÜÖÂÆπ„ÄÇ', github.repository, steps.version.outputs.tag) }}

            ---

            üêõ Â¶ÇÊûúÂèëÁé∞ÈóÆÈ¢òÊàñËÄÖÈúÄÊ±ÇËØ∑Ê±ÇÔºåËØ∑[Êèê‰∫§ Issue](https://github.com/MonchiLin/antigravity-agent/issues/new)
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Step 2: Âπ∂Ë°åÊûÑÂª∫Âíå‰∏ä‰º†
  build:
    needs: prepare-release
    uses: ./.github/workflows/tauri-build.yml
    with:
      tag: ${{ needs.prepare-release.outputs.tag }}
      ref: ${{ github.ref }}
      version: ${{ needs.prepare-release.outputs.version }}
      cache_key_suffix: release
    secrets: inherit

  # Step 3: Ëß¶Âèë updater
  trigger-updater:
    needs: [prepare-release, build]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Generate updater configuration
        uses: peter-evans/repository-dispatch@v2
        with:
          event-type: generate-updater
          client-payload: '{"tag": "${{ needs.prepare-release.outputs.tag }}"}'

  # Step 4: ÊûÑÂª∫ VS Code Êèí‰ª∂
  build-extension:
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json

      - name: Install Root Dependencies
        run: npm ci --ignore-scripts --no-audit --prefer-offline

      - name: Get Version
        id: version
        working-directory: ./vscode-extension
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        working-directory: ./vscode-extension
        run: npm ci

      - name: Bump to Build Version
        id: bump
        working-directory: ./vscode-extension
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M)
          # Create unique build version e.g. 1.5.3-build.2023...
          npm version prerelease --preid="build.$TIMESTAMP" --no-git-tag-version
          
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "üìç Build Version: $NEW_VERSION"

      - name: Build and Package Extension
        working-directory: ./vscode-extension
        run: npx @vscode/vsce package --out ./antigravity-agent-${{ steps.bump.outputs.version }}.vsix

      - name: Upload Extension to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare-release.outputs.tag }}
        run: |
          gh release upload "$TAG" vscode-extension/antigravity-agent-${{ steps.bump.outputs.version }}.vsix --clobber --repo "${{ github.repository }}"

      - name: Publish to Open VSX
        working-directory: ./vscode-extension
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        run: |
          if [ -z "$OVSX_PAT" ]; then
            echo "‚ö†Ô∏è OVSX_PAT secret not found, skipping Open VSX publish"
            exit 0
          fi
          npx ovsx publish ./antigravity-agent-${{ steps.bump.outputs.version }}.vsix --pat "$OVSX_PAT"
